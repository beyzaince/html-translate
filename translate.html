<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PDF â†’ TÃ¼rkÃ§e Ã‡eviri (Free Providers + Mini Log + MyMemory Fix)</title>
<style>
  :root { --bg:#0b0c10; --card:#15171c; --ink:#e6e6e6; --muted:#a9b0bb; --acc:#4da3ff; }
  * { box-sizing:border-box }
  body{ margin:0; font-family:-apple-system,system-ui,"SF Pro Text",Roboto,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--ink)}
  .wrap{ max-width:900px; margin:0 auto; padding:18px }
  h1{ font-size:1.2rem; font-weight:700; margin:10px 0 14px }
  .card{ background:var(--card); border:1px solid #1f2330; border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
  label{ font-size:.9rem; color:var(--muted); margin-bottom:6px; display:block }
  input[type="text"],input[type="password"],select,input[type="file"]{ width:100%; padding:12px 14px; background:#0e1117; color:var(--ink); border:1px solid #222836; border-radius:12px; outline:none; font-size:15px }
  .row{ display:flex; gap:10px; flex-wrap:wrap }
  .row>*{ flex:1 1 260px }
  .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; background:var(--acc); color:#00122b; font-weight:700; font-size:15px; cursor:pointer }
  .btn:disabled{ opacity:.6; cursor:not-allowed }
  .muted{ color:var(--muted); font-size:.85rem }
  .progress{ height:10px; background:#1f2432; border-radius:999px; overflow:hidden }
  .bar{ height:100%; width:0%; background:linear-gradient(90deg,#50e3c2,#4da3ff); transition:width .25s ease }
  .log{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0e1117; color:#d1d5db; border:1px solid #222836; border-radius:12px; padding:12px; white-space:pre-wrap; max-height:260px; overflow:auto }
  .foot{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:10px }
  .pill{ border:1px solid #2a3042; border-radius:999px; padding:6px 10px; font-size:.8rem; color:var(--muted) }
  a.dl{ color:#50e3c2; text-decoration:none; font-weight:700 }
  details{ margin-top:8px }
</style>
</head>
<body>
<div class="wrap">
  <h1>PDF â†’ TÃ¼rkÃ§e Ã‡eviri (Free)</h1>
  <div class="card">
    <div class="row">
      <div>
        <label>PDF URL (opsiyonel â€” CORS engellerse aÅŸaÄŸÄ±dan dosya seÃ§)</label>
        <input id="pdfUrl" type="text" placeholder="https://â€¦/file.pdf" autocomplete="url">
      </div>
    </div>
    <div class="row">
      <div>
        <label>veya Yerel PDF seÃ§</label>
        <input id="pdfFile" type="file" accept="application/pdf">
      </div>
    </div>

    <div class="row">
      <div>
        <label>SaÄŸlayÄ±cÄ±</label>
        <select id="provider">
          <option value="libre" selected>LibreTranslate (free, no key)</option>
          <option value="mymemory">MyMemory (free, no key)</option>
          <option value="deepl">DeepL Free (key gerekir)</option>
        </select>
      </div>
      <div>
        <label>API Key (yalnÄ±zca DeepL iÃ§in)</label>
        <input id="apiKey" type="password" placeholder="DeepL-Auth-Key ...">
      </div>
    </div>

    <details>
      <summary class="muted">GeliÅŸmiÅŸ</summary>
      <div class="row">
        <div>
          <label>LibreTranslate endpoint (opsiyonel)</label>
          <input id="ltEndpoint" type="text" placeholder="https://libretranslate.com">
        </div>
        <div>
          <label>Chunk (karakter)</label>
          <input id="chunkSize" type="text" value="12000">
        </div>
      </div>
      <div class="row">
        <div>
          <label>OCR Fallback</label>
          <select id="useOCR">
            <option value="off" selected>KapalÄ±</option>
            <option value="on">AÃ§Ä±k (Tesseract)</option>
          </select>
        </div>
        <div>
          <label>Hedef Dil</label>
          <input id="lang" type="text" value="tr">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Kaynak Dil (MyMemory iÃ§in)</label>
          <input id="srcLang" type="text" value="en" placeholder="en, de, frâ€¦">
        </div>
        <div>
          <label>MyMemory mikro-parÃ§a boyutu (~500 sÄ±nÄ±rÄ±)</label>
          <input id="mmMax" type="text" value="430">
        </div>
      </div>
      <p class="muted">Not: MyMemory 500 karakteri aÅŸan sorgularÄ± reddeder ve <code>AUTO</code> kaynak dilini kabul etmez. Kaynak dili <b>en</b> gibi 2 harfli ISO kodla gir.</p>
    </details>

    <div class="foot">
      <button id="startBtn" class="btn">BaÅŸlat</button>
      <span class="pill" id="statusPill">HazÄ±r</span>
    </div>

    <div style="margin:14px 0 8px">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div style="display:flex;gap:10px;justify-content:space-between;margin-top:6px">
        <span class="muted" id="progressText">0/0 sayfa</span>
        <span class="muted" id="chunkText">0/0 parÃ§a</span>
      </div>
    </div>

    <label>GÃ¼nlÃ¼k (log)</label>
    <div class="log" id="log"></div>

    <div class="foot">
      <button id="downloadBtn" class="btn" disabled>Sonucu indir (.md)</button>
      <a id="previewLink" class="dl" href="#" download style="display:none">Ã–nizleme / Ä°ndir</a>
    </div>

    <p class="muted" style="margin-top:8px">
      Ãœcretsiz saÄŸlayÄ±cÄ±lar paylaÅŸÄ±mlÄ± olduÄŸundan her parÃ§a arasÄ±nda kÄ±sa bekleme vardÄ±r. Safariâ€™de aÃ§.
    </p>
  </div>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js" crossorigin="anonymous"></script>
<!-- Tesseract (OCR) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
const $ = s => document.querySelector(s);
const logEl = $("#log"), bar = $("#bar"), progressText = $("#progressText"),
      chunkText = $("#chunkText"), pill = $("#statusPill"),
      dlBtn = $("#downloadBtn"), previewLink = $("#previewLink");

function log(t){ logEl.textContent += (logEl.textContent? "\n":"") + t; logEl.scrollTop = logEl.scrollHeight; }
function setBar(p){ bar.style.width = Math.max(0, Math.min(1,p))*100 + "%"; }
function setPill(t){ pill.textContent = t; }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ---------------- PDF okuma ---------------- */
async function readLocalFileAsArrayBuffer(file){
  log("ğŸ“¥ Yerel PDF okunuyor: " + (file.name || "dosya"));
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onerror=()=>rej(new Error("Dosya okunamadÄ±"));
    fr.onload =()=>res(fr.result);
    fr.readAsArrayBuffer(file);
  });
}
async function loadPDF({ url, file, useOCR=false }){
  try{
    if (file){
      const ab = await readLocalFileAsArrayBuffer(file);
      log("ğŸ—‚ï¸ PDF.js ile aÃ§Ä±lÄ±yorâ€¦");
      const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
      return await readPages(pdf, useOCR);
    } else if (url){
      log("ğŸŒ URL'den PDF Ã§ekiliyorâ€¦");
      const pdf = await pdfjsLib.getDocument({ url, withCredentials:false }).promise;
      return await readPages(pdf, useOCR);
    } else { throw new Error("PDF kaynaÄŸÄ± bulunamadÄ±"); }
  }catch(e){ log("âŒ PDF yÃ¼kleme hatasÄ±: "+e.message); throw e; }
}
async function readPages(pdf, useOCR){
  log("ğŸ“„ PDF aÃ§Ä±ldÄ± â€” Toplam sayfa: " + pdf.numPages);
  const pages=[];
  for(let i=1;i<=pdf.numPages;i++){
    let text="";
    try{
      const page=await pdf.getPage(i);
      try{ const tc=await page.getTextContent(); text = tc.items.map(it=>it.str).join(" "); }
      catch(e){ log("âš ï¸ TextContent alÄ±namadÄ± (sayfa "+i+"): "+e.message); }
      if((!text || text.trim().length<5) && useOCR){
        log("ğŸ”¤ OCR devrede (sayfa "+i+")");
        const viewport=page.getViewport({scale:2.0});
        const canvas=document.createElement("canvas"); const ctx=canvas.getContext("2d");
        canvas.width=Math.floor(viewport.width); canvas.height=Math.floor(viewport.height);
        await page.render({canvasContext:ctx,viewport}).promise;
        const dataUrl=canvas.toDataURL("image/png");
        const { data:{ text: ocrText } } = await Tesseract.recognize(dataUrl,"eng",{logger:()=>{}});
        text = ocrText || "";
      }
    }catch(e){ log("âš ï¸ Sayfa "+i+" okunamadÄ±: "+e.message); }
    pages.push({ index:i, text:(text||"").trim() });
    setBar(i/pdf.numPages);
    progressText.textContent = i + "/" + pdf.numPages + " sayfa";
  }
  log("âœ… Sayfalar okundu");
  return pages;
}
function chunkPages(pages, maxChars){
  log("ğŸ“¦ ParÃ§alara bÃ¶lÃ¼nÃ¼yorâ€¦ (limit ~"+maxChars+" karakter)");
  const chunks=[]; let buf=""; let rangeStart=1;
  for(let k=0;k<pages.length;k++){
    const p=pages[k];
    const header = `\n\n---- [PAGE ${p.index}] ----\n`;
    const piece = header + (p.text||"");
    if(buf.length + piece.length > maxChars && buf.length>0){
      chunks.push({ text:buf, start:rangeStart, end:pages[k-1].index });
      buf=""; rangeStart=p.index;
    }
    buf += piece;
  }
  if(buf.length>0){ chunks.push({ text:buf, start:rangeStart, end:pages[pages.length-1].index }); }
  log("ğŸ§© Toplam parÃ§a: "+chunks.length);
  return chunks;
}

/* ------------- YardÄ±mcÄ±: metni mikro-parÃ§alara bÃ¶l ------------- */
function splitSmart(text, maxLen=430) { // MyMemory sÄ±nÄ±rÄ± iÃ§in ~430
  if (text.length <= maxLen) return [text];
  const parts = [];
  let buf = "";
  const sentences = text.split(/(?<=[\.\!\?\n])\s+/);
  for (const s of sentences) {
    if ((buf + " " + s).length > maxLen && buf.length) {
      parts.push(buf); buf = s;
    } else {
      buf = buf ? (buf + " " + s) : s;
    }
  }
  if (buf) parts.push(buf);
  // Ã‡ok uzun tek cÃ¼mle kaldÄ±ysa kaba bÃ¶l
  const out = [];
  for (const p of parts){
    if (p.length <= maxLen) { out.push(p); continue; }
    for (let i=0;i<p.length;i+=maxLen){ out.push(p.slice(i,i+maxLen)); }
  }
  return out;
}

/* ---------------- SaÄŸlayÄ±cÄ±lar ---------------- */
// LibreTranslate: 400/413/429 ise mikro-parÃ§a + minik bekleme; olmazsa MyMemory'e dÃ¼ÅŸer
async function tr_libre(text, target="tr", endpoint) {
  const base = (endpoint && endpoint.trim()) || "https://libretranslate.com";
  const url  = base.replace(/\/+$/,"") + "/translate";

  async function callOnce(t) {
    log("ğŸŒ LT â†’ uzunluk=" + t.length);
    const resp = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ q:t, source:"auto", target:target, format:"text" })
    });
    if (!resp.ok) throw new Error("LT " + resp.status);
    const j = await resp.json();
    log("âœ… LT âœ“ ("+(j.translatedText||"").slice(0,24)+"â€¦)");
    return j.translatedText || "";
  }

  try {
    return await callOnce(text); // tek parÃ§a dene
  } catch (e) {
    if (!/LT (400|413|429)/.test(e.message)) throw e;
    const micro = splitSmart(text, 1800); // LT iÃ§in daha bÃ¼yÃ¼k mikro parÃ§a
    log("â†ªï¸ LT hata â†’ mikro parÃ§a: "+micro.length);
    let out = "";
    for (let i=0;i<micro.length;i++){
      log("ğŸ”¸ mikro "+(i+1)+"/"+micro.length);
      await sleep(800);
      out += await callOnce(micro[i]);
    }
    return out;
  }
}

// MyMemory: AUTO kabul etmez; 500 char sÄ±nÄ±rÄ± â†’ 430'luk mikro-parÃ§alar
async function tr_mymemory(text, target="tr", source="en", maxPiece=430){
  const micros = splitSmart(text, maxPiece);
  log("ğŸŒ MyMemory â†’ mikro-parÃ§a sayÄ±sÄ±=" + micros.length + " (src="+source+"|"+target+")");
  let out = "";
  for (let i=0;i<micros.length;i++){
    const q = micros[i];
    const pair = source.toLowerCase() + "|" + target.toLowerCase(); // en|tr
    const url  = "https://api.mymemory.translated.net/get?q=" + encodeURIComponent(q) + "&langpair=" + encodeURIComponent(pair);
    const resp = await fetch(url);
    if(!resp.ok){ throw new Error("MM HTTP " + resp.status); }
    const j = await resp.json();
    // API status check
    if (j.responseStatus !== 200 || !j.responseData){
      log("âš ï¸ MyMemory status=" + j.responseStatus + " â†’ boÅŸ dÃ¶ndÃ¼, tekrar dene");
      // 1 kez daha kÄ±sa bekleme ile retry
      await sleep(600);
      const r2 = await fetch(url);
      const j2 = await r2.json();
      const piece = (j2.responseData && j2.responseData.translatedText) || "";
      out += piece;
    } else {
      out += j.responseData.translatedText || "";
    }
    await sleep(500); // nazik davran
  }
  log("âœ… MyMemory âœ“ ("+out.slice(0,24)+"â€¦)");
  return out;
}

async function tr_deepl(text, target="TR", apiKey){
  if(!apiKey) throw new Error("DeepL key gerekli");
  log("ğŸŒ DeepL â†’ istek");
  const form = new URLSearchParams();
  form.append("text", text);
  form.append("target_lang", target.toUpperCase());
  const resp = await fetch("https://api-free.deepl.com/v2/translate",{
    method:"POST",
    headers:{ "Authorization":"DeepL-Auth-Key "+apiKey, "Content-Type":"application/x-www-form-urlencoded" },
    body: form.toString()
  });
  const t = await resp.text();
  if(!resp.ok) throw new Error("DL " + resp.status + " | " + t.slice(0,200));
  const j = JSON.parse(t);
  log("âœ… DeepL âœ“ ("+(j.translations?.[0]?.text||"").slice(0,24)+"â€¦)");
  return j.translations?.[0]?.text || "";
}

// SaÄŸlayÄ±cÄ± yÃ¶nlendirici + Libreden otomatik MyMemory fallback
async function translateChunkProvider(provider, text, lang, key, ltEndpoint, srcLang, mmMax){
  try {
    if (provider==="libre")    return await tr_libre(text, lang, ltEndpoint);
    if (provider==="mymemory") return await tr_mymemory(text, lang, srcLang, mmMax);
    if (provider==="deepl")    return await tr_deepl(text, lang, key);
    throw new Error("Bilinmeyen saÄŸlayÄ±cÄ±");
  } catch (e) {
    if (provider==="libre" && /LT (400|413|429)/.test(e.message)) {
      log("â†ªï¸ LT hata â†’ MyMemory'e dÃ¼ÅŸÃ¼lÃ¼yorâ€¦");
      return await tr_mymemory(text, lang, srcLang, mmMax);
    }
    throw e;
  }
}

/* ---------------- Ä°ndirme ---------------- */
function downloadText(filename, text){
  const blob = new Blob([text], { type:"text/markdown;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  previewLink.href = url; previewLink.download = filename; previewLink.style.display = "inline-block";
  dlBtn.disabled = false;
  dlBtn.onclick = () => { const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); };
}

/* ---------------- AkÄ±ÅŸ ---------------- */
document.getElementById("startBtn").addEventListener("click", async () => {
  try{
    const pdfUrl    = document.getElementById("pdfUrl").value.trim();
    const file      = document.getElementById("pdfFile").files[0] || null;
    const provider  = document.getElementById("provider").value;
    const apiKey    = document.getElementById("apiKey").value.trim();
    const ltEndpoint= document.getElementById("ltEndpoint").value.trim();
    const userChunk = parseInt(document.getElementById("chunkSize").value,10) || 12000;
    const useOCR    = document.getElementById("useOCR").value === "on";
    const lang      = (document.getElementById("lang").value || "tr").toLowerCase();
    const srcLang   = (document.getElementById("srcLang").value || "en").toLowerCase();
    const mmMax     = Math.max(200, parseInt(document.getElementById("mmMax").value,10) || 430);

    if (!pdfUrl && !file){ alert("PDF URL gir veya yerel bir PDF seÃ§"); return; }

    logEl.textContent = ""; previewLink.style.display = "none"; dlBtn.disabled = true;
    setPill("Ã‡alÄ±ÅŸÄ±yorâ€¦"); setBar(0); progressText.textContent = "0/0 sayfa"; chunkText.textContent = "0/0 parÃ§a";

    log("ğŸ“¦ PDF yÃ¼kleniyorâ€¦");
    const pages = await loadPDF({ url: pdfUrl || null, file, useOCR });
    if (!pages.length) throw new Error("PDF sayfalarÄ± okunamadÄ±");

    // Ãœcretsiz saÄŸlayÄ±cÄ±lar iÃ§in daha kÃ¼Ã§Ã¼k chunk Ã¶ner
    const chunkSize = (provider === "libre" || provider === "mymemory") ? Math.min(userChunk, 4000) : userChunk;

    const chunks = chunkPages(pages, chunkSize);
    chunkText.textContent = `0/${chunks.length} parÃ§a`;

    let output = `# Ã‡eviri â€” ${pdfUrl || (file?.name || "local.pdf")}\n\n> Not: Otomatik Ã§eviri. BaÅŸlÄ±klar/sayfalar korunmaya Ã§alÄ±ÅŸÄ±ldÄ±.\n\n`;
    for (let i=0; i<chunks.length; i++){
      const ch = chunks[i];
      log(`ğŸ¤– Ã‡eviri (parÃ§a ${i+1}/${chunks.length}) â€” Sayfa ${ch.start}â€“${ch.end} | uzunluk=${ch.text.length}`);
      chunkText.textContent = `${i+1}/${chunks.length} parÃ§a`;

      const tr = await translateChunkProvider(provider, ch.text, lang, apiKey, ltEndpoint, srcLang, mmMax);
      output += `\n\n<!-- PART ${i+1} (Pages ${ch.start}-${ch.end}) -->\n` + tr + "\n";

      await sleep(1000); // paylaÅŸÄ±mlÄ± servis nezaketi
    }

    downloadText("translation_" + Date.now() + ".md", output);
    setPill("TamamlandÄ± âœ…");
    log("âœ… Ä°ÅŸlem tamamlandÄ± â€” Ä°ndirâ€™e tÄ±kla");
  }catch(e){
    console.error(e);
    log("âŒ Hata: " + (e.message || e.toString()));
    setPill("Hata");
    alert("Hata: " + (e.message || e.toString()));
  }
});
</script>
</body>
</html>